# AI Browser Researcher 重构实施计划

## 📊 架构审计总结

**当前评分：6.5/10 → 目标评分：8.5/10**

### 已完成的改进 ✅
1. **立即清理（P0）**
   - 删除了重复的workspace目录 (`packages/live-dashboard/workspace/`)
   - 移除了未使用的配置文件 (`config/retention.json`, `config/sites.json`)
   - 清理了重复的依赖声明 (hooks包中的zod)
   - 移除了未使用的vitest依赖
   
2. **类型安全修复（P0）**
   - 修复了所有`as any`类型断言，改为正确的Zod类型推导
   - 为database操作添加了类型定义
   - 用结构化日志(pino)替换了console.log
   - TypeScript类型检查现在完全通过

## 🚀 下一步重构方案（按优先级）

### Phase 1: 架构简化 (P1 - 3天)

#### 1.1 合并packages结构
**问题**: 4个packages总共<500行代码，monorepo过度复杂

**解决方案**:
```
建议的新结构：
src/
├─ core/              # 核心研究逻辑
│  ├─ planner.ts      # 研究规划
│  ├─ searcher.ts     # 搜索引擎
│  ├─ browser.ts      # 浏览器抓取
│  ├─ extractor.ts    # 内容提取
│  ├─ analyzer.ts     # 内容分析
│  └─ reporter.ts     # 报告生成
├─ tools/             # MCP工具合并
│  ├─ research-mcp.ts # 当前mcp-research-tools
│  └─ types.ts        # 类型定义合并
├─ dashboard/         # 仪表盘服务合并
│  ├─ live-server.ts  # SSE实时面板
│  └─ static-gen.ts   # 静态仪表盘生成
├─ hooks/             # 策略控制合并
│  └─ policy-engine.ts# 3个hook脚本合并
├─ storage/           # 数据存储
│  └─ sqlite.ts       # 数据库操作
└─ index.ts           # 统一入口点
```

**具体步骤**:
1. 创建新的src目录结构
2. 将packages中的代码迁移到对应目录
3. 更新所有import路径
4. 统一package.json配置
5. 更新构建脚本

#### 1.2 移除过度抽象
**问题**: xstate状态机只有简单状态转换，无实际业务逻辑

**解决方案**:
- 用简单的函数调用链替代状态机
- 实现真正的研究工作流编排
- 添加错误处理和重试机制

### Phase 2: 功能完善 (P1 - 5天)

#### 2.1 实现缺失的子代理
**当前状态**: README声称的10个子代理未实现

**实现计划**:
```typescript
// src/core/agents/
├─ planner.ts     # 研究计划制定
├─ searcher.ts    # 搜索执行
├─ browser.ts     # 网页浏览
├─ extractor.ts   # 内容抽取和规约
├─ analyst.ts     # 分析综合
├─ critic.ts      # 证据审计和风险评估
├─ facilitator.ts # 人机协作协调
├─ writer.ts      # 报告生成
├─ dashboarder.ts # 仪表盘生成
└─ memory.ts      # 记忆管理（Qdrant集成）
```

#### 2.2 端到端工作流集成
**目标**: 实现真正的研究工作流自动化

**工作流设计**:
```
1. Planner: 分析研究主题，制定检索计划
2. Searcher: 执行多源搜索（Web/学术/新闻）
3. Browser: 批量访问URL，获取网页内容
4. Extractor: 内容清洗、规约化、质量评分
5. Analyst: 交叉分析，提出假设和反证
6. Critic: 识别偏见、评估证据质量
7. Facilitator: 在关键节点暂停请示人类
8. Writer: 生成结构化研究报告
9. Dashboarder: 创建交互式数据仪表盘
10. Memory: 将研究结论存储到向量数据库
```

### Phase 3: 质量提升 (P2 - 1周)

#### 3.1 测试覆盖
**目标**: 从0%测试覆盖提升到80%+

**测试策略**:
- 单元测试：各个子代理的核心逻辑
- 集成测试：端到端工作流
- E2E测试：真实网站抓取和报告生成

#### 3.2 错误处理和容错
**当前问题**: 缺乏错误处理和容错机制

**改进方案**:
- 网络请求重试机制
- 优雅降级（搜索失败时的fallback）
- 详细的错误日志和用户反馈

#### 3.3 配置和部署
**目标**: 简化配置和部署流程

**改进点**:
- 环境变量统一管理
- Docker容器化支持
- 配置验证和错误提示

### Phase 4: 高级特性 (P3 - 2周)

#### 4.1 性能优化
- 并发处理：批量URL抓取
- 缓存机制：避免重复请求
- 流式处理：大文件处理优化

#### 4.2 扩展性
- 插件架构：支持自定义搜索源
- API接口：支持程序化调用
- 配置模板：不同研究场景的预设

## 📈 成功指标

### Phase 1完成后
- 代码量减少30%（从分散在4个包变成单一结构）
- 构建时间减少50%
- 新功能开发速度提升2倍

### Phase 2完成后
- 10个子代理全部实现
- 端到端工作流可用
- 支持真实研究任务

### Phase 3完成后
- 测试覆盖率>80%
- 错误率<5%
- 用户满意度>8/10

### Phase 4完成后
- 性能提升3倍
- 支持10+搜索源
- API调用延迟<2s

## 🚨 风险评估

### 高风险
1. **数据迁移**: packages合并可能导致配置丢失
   - 缓解：详细备份和测试
   
2. **功能回归**: 重构可能影响现有功能
   - 缓解：保持现有API兼容

### 中风险
1. **依赖冲突**: 合并包可能产生依赖冲突
   - 缓解：渐进式迁移

2. **性能退化**: 新架构可能影响性能
   - 缓解：性能基准测试

## 💡 建议

### 立即执行（本周）
1. 开始Phase 1的架构简化
2. 设立性能基准测试
3. 建立回滚机制

### 分支策略
- `main`: 当前稳定版本
- `refactor/phase1`: 架构简化分支
- `refactor/phase2`: 功能完善分支

### 里程碑检查点
- Phase 1: 新架构构建成功，现有功能保持
- Phase 2: 10个子代理实现，工作流可用
- Phase 3: 测试通过，质量达标
- Phase 4: 性能达标，功能完整

---

**预期时间线**: 总计3-4周
**预期投入**: 1人全职开发
**预期成果**: 架构评分从6.5/10提升到8.5/10，功能完整度从30%提升到90%